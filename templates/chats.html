<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <title>–ß–∞—Ç—ã ‚Äî SkyMessage</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.min.js"></script>
</head>
<body class="h-screen bg-slate-950 text-slate-100">
  <div class="h-full grid grid-cols-[320px_1fr]">
    <aside class="h-full border-r border-slate-800 bg-slate-900 flex flex-col">
      <div class="p-4 border-b border-slate-800 flex items-center justify-between">
        <a href="/" class="text-lg font-bold">SkyMessage</a>
        <div class="space-x-3 text-sm">
          <a class="text-slate-400 hover:text-slate-200" href="/logout">–í—ã–π—Ç–∏</a>
        </div>
      </div>

      <!-- –ü–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π -->
      <div class="p-3">
        <div class="text-xs uppercase text-slate-400 mb-2">–ù–∞–π—Ç–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</div>
        <div class="flex gap-2">
          <input id="searchInput" class="flex-1 px-3 py-2 rounded-xl bg-slate-800 border border-slate-700 focus:outline-none" placeholder="–õ–æ–≥–∏–Ω..." />
          <button id="searchBtn" class="px-3 py-2 rounded-xl bg-blue-600 hover:bg-blue-500">–ù–∞–π—Ç–∏</button>
        </div>
        <div id="searchResult" class="mt-2 text-sm"></div>
      </div>

      <div class="px-3 py-2 text-xs uppercase text-slate-400">–ß–∞—Ç—ã</div>
      <ul id="chatList" class="flex-1 overflow-y-auto"></ul>
    </aside>

    <!-- –û—Å–Ω–æ–≤–Ω–æ–π —á–∞—Ç -->
    <main class="h-full flex flex-col">
      <header id="chatHeader" class="h-16 border-b border-slate-800 flex items-center px-4">
        <div class="font-semibold">–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç</div>
      </header>
      <section id="messages" class="flex-1 overflow-y-auto p-4 space-y-2"></section>
      <footer class="p-4 border-t border-slate-800 flex gap-2">
        <input id="msgInput" class="flex-1 px-4 py-3 rounded-xl bg-slate-800 border border-slate-700 focus:outline-none" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ..." />
        <input type="file" id="fileInput" accept="image/*,video/*" class="hidden" />
        <button id="fileBtn" class="px-3 py-2 rounded-xl bg-yellow-600 hover:bg-yellow-500">üìé</button>
        <button id="callBtn" class="px-3 py-2 rounded-xl bg-purple-600 hover:bg-purple-500">üìû</button>
        <button id="sendBtn" class="px-4 py-3 rounded-xl bg-emerald-600 hover:bg-emerald-500">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
      </footer>
      <video id="localVideo" autoplay muted class="w-32 h-32 hidden absolute bottom-4 right-4 rounded-xl border border-slate-700"></video>
      <video id="remoteVideo" autoplay class="w-64 h-64 hidden absolute bottom-20 right-4 rounded-xl border border-slate-700"></video>
    </main>
  </div>

<script>
let me = null;
let chats = [];
let selectedChatId = null;
const socket = io();

// --- –§–æ—Ä–º–∞—Ç –≤—Ä–µ–º–µ–Ω–∏ ---
function fmtTime(iso){ if(!iso) return ''; const d=new Date(iso); return d.toLocaleString(); }

// --- –¢–µ–∫—É—â–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ---
async function fetchMe(){ const r=await fetch('/api/me'); me=(await r.json()).user; }

// --- –°–ø–∏—Å–æ–∫ —á–∞—Ç–æ–≤ ---
async function fetchChats(){
  const r = await fetch('/api/chats'); chats = await r.json();
  const list = document.getElementById('chatList'); list.innerHTML='';
  chats.forEach(c=>{
    const li = document.createElement('li');
    li.className='px-3 py-3 hover:bg-slate-800 cursor-pointer border-b border-slate-800';
    li.innerHTML=`<div class="font-semibold">@${c.peer.username}</div>
      <div class="text-slate-400 text-sm truncate">${c.last.text || ''}</div>`;
    li.onclick=()=>selectChat(c.id,c.peer.username);
    list.appendChild(li);
  });
}

// --- –í—ã–±–æ—Ä —á–∞—Ç–∞ ---
async function selectChat(chatId, peerName){
  selectedChatId = chatId;
  document.getElementById('chatHeader').innerHTML='<div class="font-semibold">@'+peerName+'</div>';
  document.getElementById('messages').innerHTML='';
  socket.emit('join_chat', {chat_id:chatId});
  const r = await fetch('/api/messages/'+chatId); const msgs=await r.json();
  msgs.forEach(renderMsg);
}

// --- –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π ---
function renderMsg(m){
  const wrap=document.createElement('div');
  const mine=m.sender_id===me.id;
  wrap.className='max-w-[80%] '+(mine?'ml-auto text-right':'mr-auto text-left');
  let content=m.text;
  if(m.media_url) content=`<a href="${m.media_url}" target="_blank">[–ú–µ–¥–∏–∞]</a>`;
  wrap.innerHTML=`<div class="inline-block px-3 py-2 rounded-xl ${mine?'bg-emerald-700':'bg-slate-800'}">
    <div class="text-sm">${content}</div>
    <div class="text-[10px] text-slate-300 mt-1">${fmtTime(m.timestamp)}</div>
  </div>`;
  document.getElementById('messages').appendChild(wrap);
  document.getElementById('messages').scrollTop=document.getElementById('messages').scrollHeight;
}

// --- –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π ---
document.getElementById('sendBtn').onclick=async()=>{
  const input=document.getElementById('msgInput'); const text=input.value.trim();
  if(!text&&!selectedChatId) return;
  const r=await fetch('/api/send_message',{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({chat_id:selectedChatId,text})
  });
  const j=await r.json();
  if(r.ok) input.value='';
  // –ù–ï –¥—É–±–ª–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ, —Å–µ—Ä–≤–µ—Ä –æ—Ç–ø—Ä–∞–≤–∏—Ç —á–µ—Ä–µ–∑ socket.io
};

// --- –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–æ–≤ ---
document.getElementById('fileBtn').onclick=()=>document.getElementById('fileInput').click();
document.getElementById('fileInput').onchange=async(e)=>{
  const file=e.target.files[0]; if(!file||!selectedChatId) return;
  const fd=new FormData(); fd.append('file',file); fd.append('chat_id',selectedChatId);
  const r=await fetch('/api/upload_media',{method:'POST',body:fd});
  const j=await r.json();
  if(r.ok) { input.value=''; } // —Å–µ—Ä–≤–µ—Ä –ø—Ä–∏—à–ª—ë—Ç —á–µ—Ä–µ–∑ socket.io
};

// --- –ü–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π ---
document.getElementById('searchBtn').onclick=async()=>{
  const q=document.getElementById('searchInput').value.trim(); const res=document.getElementById('searchResult'); res.textContent='–ü–æ–∏—Å–∫...';
  const r=await fetch('/api/search_user',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({query:q})});
  const j=await r.json();
  if(!j.user){ res.textContent='–ù–∏–∫—Ç–æ –Ω–µ –Ω–∞–π–¥–µ–Ω'; return; }
  res.innerHTML=`–ù–∞–π–¥–µ–Ω: <b>@${j.user.username}</b> <button id="startChat" class="ml-2 px-2 py-1 rounded bg-blue-600">–û—Ç–∫—Ä—ã—Ç—å —á–∞—Ç</button>`;
  document.getElementById('startChat').onclick=async()=>{
    const r2=await fetch('/api/create_chat',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({peer_id:j.user.id})});
    const j2=await r2.json(); await fetchChats(); selectChat(j2.chat_id,j.user.username);
  };
};

// --- WebRTC –∑–≤–æ–Ω–∫–∏ ---
let localStream, pc;
document.getElementById('callBtn').onclick=startCall;
async function startCall(){
  localStream=await navigator.mediaDevices.getUserMedia({audio:true,video:true});
  document.getElementById('localVideo').srcObject=localStream;
  document.getElementById('localVideo').classList.remove('hidden');

  pc=new RTCPeerConnection();
  localStream.getTracks().forEach(t=>pc.addTrack(t,localStream));
  pc.ontrack=e=>{ document.getElementById('remoteVideo').srcObject=e.streams[0]; document.getElementById('remoteVideo').classList.remove('hidden'); };
  pc.onicecandidate=e=>{ if(e.candidate) socket.emit('webrtc_ice',{candidate:e.candidate,chat_id:selectedChatId}); };

  const offer=await pc.createOffer(); await pc.setLocalDescription(offer);
  socket.emit('webrtc_offer',{sdp:offer,chat_id:selectedChatId});
}

// --- Socket.IO ---
socket.on('connect',()=>{});
socket.on('message',m=>{ if(m.chat_id===selectedChatId) renderMsg(m); else fetchChats(); });

// WebRTC —Å–∏–≥–Ω–∞–ª–∏–∑–∞—Ü–∏—è
socket.on('webrtc_offer',async m=>{
  if(m.chat_id!==selectedChatId) return;
  localStream=await navigator.mediaDevices.getUserMedia({audio:true,video:true});
  document.getElementById('localVideo').srcObject=localStream; document.getElementById('localVideo').classList.remove('hidden');

  pc=new RTCPeerConnection();
  localStream.getTracks().forEach(t=>pc.addTrack(t,localStream));
  pc.ontrack=e=>{ document.getElementById('remoteVideo').srcObject=e.streams[0]; document.getElementById('remoteVideo').classList.remove('hidden'); };
  pc.onicecandidate=e=>{ if(e.candidate) socket.emit('webrtc_ice',{candidate:e.candidate,chat_id:selectedChatId}); };
  await pc.setRemoteDescription(new RTCSessionDescription(m.sdp));
  const answer=await pc.createAnswer(); await pc.setLocalDescription(answer);
  socket.emit('webrtc_answer',{sdp:answer,chat_id:selectedChatId});
});
socket.on('webrtc_answer',async m=>{ await pc.setRemoteDescription(new RTCSessionDescription(m.sdp)); });
socket.on('webrtc_ice',m=>{ if(pc) pc.addIceCandidate(new RTCIceCandidate(m.candidate)); });

// --- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è ---
(async function init(){ await fetchMe(); if(!me){ window.location='/login'; return; } await fetchChats(); })();
</script>
</body>
</html>
