<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <title>Чаты — SkyMessage</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.min.js"></script>
</head>
<body class="h-screen bg-slate-950 text-slate-100">
  <div class="h-full grid grid-cols-[320px_1fr]">
    <aside class="h-full border-r border-slate-800 bg-slate-900 flex flex-col">
      <div class="p-4 border-b border-slate-800 flex items-center justify-between">
        <a href="/" class="text-lg font-bold">SkyMessage</a>
        <div class="space-x-3 text-sm">
          <a class="text-slate-400 hover:text-slate-200" href="/logout">Выйти</a>
        </div>
      </div>
      <div class="p-3">
        <div class="text-xs uppercase text-slate-400 mb-2">Найти пользователя</div>
        <div class="flex gap-2">
          <input id="searchInput" class="flex-1 px-3 py-2 rounded-xl bg-slate-800 border border-slate-700 focus:outline-none" placeholder="Логин..." />
          <button id="searchBtn" class="px-3 py-2 rounded-xl bg-blue-600 hover:bg-blue-500">Найти</button>
        </div>
        <div id="searchResult" class="mt-2 text-sm"></div>
      </div>
      <div class="px-3 py-2 text-xs uppercase text-slate-400">Чаты</div>
      <ul id="chatList" class="flex-1 overflow-y-auto"></ul>
    </aside>
    <main class="h-full flex flex-col">
      <header id="chatHeader" class="h-16 border-b border-slate-800 flex items-center px-4">
        <div class="font-semibold">Выберите чат</div>
      </header>
      <section id="messages" class="flex-1 overflow-y-auto p-4 space-y-2"></section>
      <footer class="p-4 border-t border-slate-800 flex gap-2">
        <input id="msgInput" class="flex-1 px-4 py-3 rounded-xl bg-slate-800 border border-slate-700 focus:outline-none" placeholder="Сообщение..." />
        <button id="sendBtn" class="px-4 py-3 rounded-xl bg-emerald-600 hover:bg-emerald-500">Отправить</button>
      </footer>
    </main>
  </div>

<script>
let me=null, chats=[], selectedChatId=null;
const socket = io();

function fmtTime(iso){ if(!iso) return ''; return new Date(iso).toLocaleString(); }
function scrollBottom(){ const cont=document.getElementById('messages'); if(cont) cont.scrollTop=cont.scrollHeight; }

function renderMsg(m){
    const wrap=document.createElement('div');
    const mine=m.sender_id===me.id;
    wrap.className='max-w-[80%] '+(mine?'ml-auto text-right':'mr-auto text-left');
    wrap.innerHTML=`<div class="inline-block px-3 py-2 rounded-xl ${mine?'bg-emerald-700':'bg-slate-800'}">
                        <div class="text-sm">${m.text}</div>
                        <div class="text-[10px] text-slate-300 mt-1">${fmtTime(m.timestamp)}</div>
                     </div>`;
    const cont=document.getElementById('messages');
    if(cont){ cont.appendChild(wrap); scrollBottom(); }
}

async function fetchMe(){
    const r=await fetch('/api/me'); const j=await r.json(); me=j.user;
    if(!me) window.location='/login';
}

async function fetchChats(){
    const r=await fetch('/api/chats'); chats=await r.json();
    const list=document.getElementById('chatList'); list.innerHTML='';
    chats.forEach((c,i)=>{
        const li=document.createElement('li');
        li.className='px-3 py-3 hover:bg-slate-800 cursor-pointer border-b border-slate-800';
        li.innerHTML=`<div class="font-semibold">@${c.peer.username}</div>
                      <div class="text-slate-400 text-sm truncate">${c.last.text||''}</div>`;
        li.onclick=()=>selectChat(c.id,c.peer.username);
        list.appendChild(li);
    });
}

async function selectChat(chatId, peerName){
    selectedChatId=chatId;
    document.getElementById('chatHeader').innerHTML='<div class="font-semibold">@'+peerName+'</div>';
    document.getElementById('messages').innerHTML='';
    socket.emit('join_chat',{chat_id:chatId});
    const liIndex=chats.findIndex(c=>c.id===chatId);
    const li=document.querySelector(`#chatList li:nth-child(${liIndex+1})`);
    if(li) li.classList.remove('bg-slate-700');

    const r=await fetch('/api/messages/'+chatId);
    const msgs=await r.json();
    msgs.forEach(renderMsg);
    scrollBottom();
}

document.getElementById('sendBtn')?.addEventListener('click', async ()=>{
    const input=document.getElementById('msgInput');
    const text=input.value.trim();
    if(!text||!selectedChatId) return;
    const r=await fetch('/api/send_message',{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({chat_id:selectedChatId, text})
    });
    if(r.ok){ input.value=''; }
});

document.getElementById('searchBtn')?.addEventListener('click', async ()=>{
    const q=document.getElementById('searchInput').value.trim();
    const res=document.getElementById('searchResult');
    res.textContent='Поиск...';
    const r=await fetch('/api/search_user',{
        method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({query:q})
    });
    const j=await r.json();
    if(!j.user){ res.textContent='Никто не найден'; return; }
    res.innerHTML=`Найден: <b>@${j.user.username}</b> <button id="startChat" class="ml-2 px-2 py-1 rounded bg-blue-600">Открыть чат</button>`;
    document.getElementById('startChat')?.addEventListener('click', async ()=>{
        const r2=await fetch('/api/create_chat',{
            method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({peer_id:j.user.id})
        });
        const j2=await r2.json();
        await fetchChats();
        selectChat(j2.chat_id,j.user.username);
    });
});

// Socket.IO обработка сообщений
socket.on('message', m=>{
    if(!m || !me) return;
    const chatIndex=chats.findIndex(c=>c.id===m.chat_id);
    if(chatIndex>=0){
        chats[chatIndex].last={text:m.text,timestamp:m.timestamp};
        const li=document.querySelector(`#chatList li:nth-child(${chatIndex+1})`);
        if(li){
            li.querySelector('div:nth-child(2)').textContent=m.text;
            if(selectedChatId!==m.chat_id) li.classList.add('bg-slate-700');
        }
    }
    if(selectedChatId===m.chat_id) renderMsg(m);
});

// Инициализация
(async()=>{ await fetchMe(); await fetchChats(); })();
</script>
</body>
</html>
